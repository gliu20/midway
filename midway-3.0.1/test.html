<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/6.2.4/firebase-auth.js"></script>

<script>
// Your web app's Firebase configuration
var firebaseConfig = {
    apiKey: "AIzaSyBNCdvM5pzkiSuHKGOolx0HuFgM2VBWITU",
    authDomain: "midway-application.firebaseapp.com",
    databaseURL: "https://midway-application.firebaseio.com",
    projectId: "midway-application",
    storageBucket: "midway-application.appspot.com",
    messagingSenderId: "252261994154",
    appId: "1:252261994154:web:b0efaf93bcebd689"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
</script>

<script>

var midway = {};

midway.handleError = function (errCode,errMesg) {
	console.error(errCode,errMesg);
}

// rest api for handling data //////////////////////////////////////////////////
midway.rest = {};

midway.rest.fetch = function (path,token,options) {
	return new Promise (function (resolve,reject) {
		
		var url = firebaseConfig.databaseURL;
		
		url += "/" + path;
		url += ".json?auth=" + token;
		url += options ? "&" + options : "";
		
		fetch(url).then(function(response) {
			if (response.ok) {
				resolve(response);
			}
			else {
				midway.handleError(response.status,response.statusText);
				reject();
			}
		}).catch(function(error) {
			midway.handleError(undefined,error);
			reject();
		})
	});
}
////////////////////////////////////////////////////////////////////////////////

// auth ////////////////////////////////////////////////////////////////////////
midway.auth = {};

midway.auth.authUser = function () {
	var provider = new firebase.auth.GoogleAuthProvider();
	
	return new Promise(function (resolve,reject) {
		firebase.auth().signInWithPopup(provider).then(function(result) {
  			var token = result.credential.accessToken;
  			var user = result.user;
  			
  			resolve();
		}).catch(function(error) {
  			var errorCode = error.code;
  			var errorMessage = error.message;
  			
  			midway.handleError(error.code,error.message);
  			reject();
		});
	});
}

midway.auth.getCurrentUser = async function () {
	var user = firebase.auth().currentUser;

	if (!user) {
		await midway.auth.authUser();
		user = firebase.auth().currentUser;
	}
	
	return user;
}

midway.auth.getToken = async function () {
	var user = await midway.auth.getCurrentUser();
	
	// id tokens are NOT access tokens generated by the OAuth2 system.
	// Instead, they are used by firebase and expire after 1 hour
	// TODO figure out way to use REST api without tokens expiring after
	// 1 hour to limit overhead on server
	return await user.getIdToken();
}

midway.auth.getSchoolCode = async function () {
	// getCurrentUser automatically signs in user if necessary. getToken will
	// return the firebase token id which expires after an hour
	var user = await midway.auth.getCurrentUser();
	var token = await midway.auth.getToken();
	
	var schoolCodeUrl = "users/" + user.uid + "/schoolCode";
	var response = await midway.rest.fetch(schoolCodeUrl,token);
	
	return await response.json();
}

midway.auth.getSchoolCodeFromEmail = async function () {
	// getCurrentUser automatically signs in user if necessary. getToken will
	// return the firebase token id which expires after an hour
	var user = await midway.auth.getCurrentUser();
	var domain = user.email.split("@")[1].replace(/\./,"-");
	var token = await midway.auth.getToken();
	
	var schoolCodeUrl = "emailLookup/" + domain + "/0";
	var response = await midway.rest.fetch(schoolCodeUrl,token);
	
	return await response.json();
}

//TODO
midway.auth.setSchoolCode = async function () {
	// getCurrentUser automatically signs in user if necessary. getToken will
	// return the firebase token id which expires after an hour
	var user = await midway.auth.getCurrentUser();
	var token = await midway.auth.getToken();
	
	var schoolCodeUrl = "users/" + user.uid + "/schoolCode";
	
	// TODO put/update command or whatever
	var response = await midway.rest.fetch(schoolCodeUrl,token);
	
	return await response.json();
}

midway.auth.checkSchoolCode = async function (code) {
	// getCurrentUser automatically signs in user if necessary. getToken will
	// return the firebase token id which expires after an hour
	var user = await midway.auth.getCurrentUser();
	var token = await midway.auth.getToken();
	
	var schoolCodeCheckUrl = "schools/" + code + "/schoolName";
	var response,isValid;
	
	try {
		response = await midway.rest.fetch(
			schoolCodeCheckUrl,
			token
		);
	
		await response.json();// true or false if schoolCode is valid or not
		
		isValid = true;
	}
	catch (error) {
		isValid = false;
	}
	
	return isValid;
}


// sign in flow
// 1. get schoolCode
// 2. if exists, check it... 
// 3. no work get it from email and check it...
// 4. fail otherwise
midway.auth.initiateSignIn = async function () {
	var schoolCode, isSchoolCodeValid;
	
	try {
		// (step 1 and 2) get school code and check if it works
		schoolCode = await midway.auth.getSchoolCode();
		isSchoolCodeValid = await midway.auth.checkSchoolCode(schoolCode);
	}
	catch (error) {
		// (step 3) assume school code is invalid
		isSchoolCodeValid = false;
	}
	
	if (isSchoolCodeValid) {
		midway.auth.schoolCode = schoolCode;
		
		return true;// indicate success
	}
	
	
	
	// (step 3 cont...) get school code from email
	try {
		// get schoolCodeFromEmail and check if valid
		schoolCode = await midway.auth.getSchoolCodeFromEmail();
		isSchoolCodeValid = await midway.auth.checkSchoolCode(schoolCode);
	}
	catch (error) {
		// (step 4) assume school code is invalid
		isSchoolCodeValid = false;
	}
	
	if (isSchoolCodeValid) {
		midway.auth.schoolCode = schoolCode;
		
		return true;// indicate success
	}
	
	// At this point, one of the following happened:
	// A. cached schoolCode does not exist or work
	// B. or email domain based schoolCode does not exist or work
	return false;
}

////////////////////////////////////////////////////////////////////////////////


  function gotData(data) {
    console.log(data);
  }
</script>

<script src="https://midway-application.firebaseio.com/users/AaWEMN7jezdslenNixI0wyWyiWA2/schoolCode.json?auth=eyJhbGciOiJSUzI1NiIsImtpZCI6IjI2OGNhNTBjZTY0YjQxYWIzNGZhMDM1NzIwMmQ5ZTk0ZTcyYmQ2ZWMiLCJ0eXAiOiJKV1QifQ.eyJuYW1lIjoiR2VvcmdlIExpdSIsInBpY3R1cmUiOiJodHRwczovL2xoNC5nb29nbGV1c2VyY29udGVudC5jb20vLUsxLS03Y3g1TUJZL0FBQUFBQUFBQUFJL0FBQUFBQUFBQVNrL29Da29jMV9oWXp3L3Bob3RvLmpwZyIsImlzcyI6Imh0dHBzOi8vc2VjdXJldG9rZW4uZ29vZ2xlLmNvbS9taWR3YXktYXBwbGljYXRpb24iLCJhdWQiOiJtaWR3YXktYXBwbGljYXRpb24iLCJhdXRoX3RpbWUiOjE1NjY3MzU5NjEsInVzZXJfaWQiOiJBYVdFTU43amV6ZHNsZW5OaXhJMHd5V3lpV0EyIiwic3ViIjoiQWFXRU1ON2plemRzbGVuTml4STB3eVd5aVdBMiIsImlhdCI6MTU2NjczNjk4NiwiZXhwIjoxNTY2NzQwNTg2LCJlbWFpbCI6ImdsaXUyMEBzY2Fyc2RhbGVzY2hvb2xzLm9yZyIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJmaXJlYmFzZSI6eyJpZGVudGl0aWVzIjp7Imdvb2dsZS5jb20iOlsiMTE1OTY4MTQ5NjIyMTg0OTUyNjUwIl0sImVtYWlsIjpbImdsaXUyMEBzY2Fyc2RhbGVzY2hvb2xzLm9yZyJdfSwic2lnbl9pbl9wcm92aWRlciI6Imdvb2dsZS5jb20ifX0.u-_H-1edLCqdDzpejQElAaF8s2-8SYH0m5Fxuty8aquU7LamqAjRe7mmG2YnRDtkMJxknbLMb3Das-LEgdJ-P_UO2KhXzV5Ay3g4C2Mq7hTTD_4t_FpqrbYcut5eWVUxxG8p8SAqko89DHZqXAPG91ywtFlmj-t4sl2--n8BGgj6kQf2WixQijqjpLCv3uOv487McsQllC44_3UO0ERhRd-429E2u-avSGE3dGvvge2ymxpfq77MUTIm_Z1AyN_pvBhVvaJL8sFp7ZP8wESccjp4hMzYsICAmNpw4CR9_0EZw863k4ZJv1c9I14zCAKCAFsJuDCilU0qh3bdCNnARg&callback=gotData"></script>
